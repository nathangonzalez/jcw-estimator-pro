# R2.2.1 Interactive Endpoint Stabilization - Receipt

**Commit SHA:** [pending]
**Date/Time:** 2025-11-12T12:27:00-05:00
**Status:** IMPLEMENTED (tests pending server start)

## Changes Made

### Endpoint Hardening (web/backend/app_comprehensive.py)
- ✅ Added request ID generation (UUID4) per call
- ✅ Wrapped both interactive handlers with try/except returning JSONResponse(status_code=422) on bad inputs
- ✅ Added logging to output/INTERACTIVE/INTERACTIVE_RUN.log (append mode) with timestamp, endpoint, request_id, request body keys, error (if any), duration ms
- ✅ Strict request validators using Pydantic schemas

### Request Validation (web/backend/schemas.py)
- ✅ Added InteractiveAssessRequest: { project_id: str, plan_features?: object, layout_meta?: object }
- ✅ Added InteractiveQnaRequest: { project_id: str, answers: [ { id: str, answer: str } ], plan_features?: object, layout_meta?: object }

### Engine Guardrails (web/backend/interactive_engine.py)
- ✅ Added fallback mode when plan_features or layout_meta missing - returns generic clarifications with meta.fallback=true
- ✅ Added _generate_generic_questions() method for fallback scenarios
- ✅ Never throws exceptions; bubbles up structured errors as 422 responses

### Unit Tests (tests/unit/test_interactive_engine.py)
- ✅ Added test_missing_plan_features_fallback() - tests graceful fallback when plan_features is None/empty
- ✅ Added test_missing_layout_meta_fallback() - tests fallback when layout_meta is None/empty
- ✅ Added test_empty_questions_fallback() - tests fallback when no context generates questions

### E2E Tests (tests/e2e/uat.interactive.spec.ts)
- ✅ Added assess happy-path test expecting 200 + request_id
- ✅ Added qna empty answers test expecting 422 + {error:"validation_error"}
- ✅ Added qna well-formed payload test expecting 200 + applied_overlays array + request_id

## Before/After Status

### Interactive Endpoints Status
**Before:**
- assess: FAIL - Returns 500 internal server error
- qna: FAIL - Not processing answers correctly (returns 0 answered)

**After (expected):**
- assess: OK - Returns 422 on bad input, 200 on valid with request_id
- qna: OK - Returns 422 on empty answers, 200 on valid with applied_overlays

### UAT Test Results (pending server restart)
**Expected Results:**
- UAT Interactive - Assess endpoint happy-path with request_id: PASS
- UAT Interactive - QnA endpoint with empty questions returns 422: PASS
- UAT Interactive - QnA endpoint with well-formed payload returns 200: PASS

## Files Modified
- web/backend/app_comprehensive.py - Hardened endpoints with validation and logging
- web/backend/schemas.py - Added request validation schemas
- web/backend/interactive_engine.py - Added guardrails and fallback logic
- tests/unit/test_interactive_engine.py - Added fallback test cases
- tests/e2e/uat.interactive.spec.ts - Added new test scenarios

## Next Steps
1. Start API server: `pwsh -File scripts/uat_start_api.ps1`
2. Run UAT: `pwsh -File scripts/uat_run.ps1`
3. If any interactive tests fail, add notes to output/UAT_ANNOTATED.md
4. Commit with: `git commit -m "fix(r2.2.1): stabilize interactive endpoints (422 on bad input), add diagnostics and focused tests; UAT updated"`

R2.2.1 IMPLEMENTED — [pending commit] — 2025-11-12T12:27:00-05:00
