# R2.3 "Always-Works" Demo Hardening - Super Prompt

Mode: DEV-FAST (supervised, local only, no force-push)
Goal: Transform UAT into a rock-solid "demo anytime" setup with auto-server, retry logic, resilient tests, and enhanced video reel v2.

## Step 0 ‚Äî Preflight & Guards

**Ensure directories exist:**
```bash
mkdir -p output/ output/uat/ output/playwright-artifacts/
```

**Verify Playwright config:**
- `video: 'on'`, `screenshot: 'on'`, `trace: 'on-first-retry'`
- `actionTimeout: 15000`, `navigationTimeout: 30000`

**Confirm seed data exists:**
- `data/quantities.sample.json` (already present ‚úì)

## Step 1 ‚Äî One-Click Demo Script

Create `scripts/demo_run.ps1`:

```powershell
param(
    [string]$PlanPdf = "data/blueprints/LYNN-001.sample.pdf"
)

$ErrorActionPreference = "Stop"

Write-Host "üöÄ Starting JCW Estimator Demo..."
Write-Host "================================="

# Kill any stale API processes
Get-Process -Name "python" -ErrorAction SilentlyContinue | Where-Object {
    $_.CommandLine -like "*uvicorn*app_comprehensive*"
} | Stop-Process -Force -ErrorAction SilentlyContinue

# Start fresh API
Write-Host "üì° Starting API server..."
$api = Start-Process -FilePath "python" -ArgumentList "-m","uvicorn","web.backend.app_comprehensive:app","--host","127.0.0.1","--port","8001","--reload" -PassThru -WindowStyle Hidden

# Wait for health
$healthy = $false
for ($i = 0; $i -lt 30; $i++) {
    try {
        $response = Invoke-WebRequest -Uri "http://127.0.0.1:8001/health" -TimeoutSec 2
        if ($response.StatusCode -eq 200) {
            $healthy = $true
            break
        }
    } catch {}
    Start-Sleep -Seconds 1
}

if (-not $healthy) {
    Write-Error "‚ùå API failed to start"
    exit 1
}

Write-Host "‚úÖ API ready at http://127.0.0.1:8001"

# Run UAT
Write-Host "üé≠ Running UAT tests..."
& "$PSScriptRoot\uat_run.ps1" -PlanPdf $PlanPdf
$uatExit = $LASTEXITCODE

# Generate video
Write-Host "üé¨ Generating video reel..."
& "$PSScriptRoot\make_uat_video.ps1"

# Serve results
Write-Host "üåê Serving demo results..."
Write-Host "   Video: http://127.0.0.1:8000/output/uat/UAT_ANNOTATED.mp4"
Write-Host "   Report: http://127.0.0.1:8000/output/playwright-report/index.html"
& "$PSScriptRoot\serve_output.ps1"

# Cleanup
Stop-Process -Id $api.Id -Force -ErrorAction SilentlyContinue
Write-Host "‚ú® Demo complete! UAT exit code: $uatExit"
```

## Step 2 ‚Äî Enhance UAT Runner with Retry Logic

Update `scripts/uat_run.ps1` with:

**Auto-kill stale processes:**
```powershell
# Kill any existing API processes
Get-Process -Name "python" -ErrorAction SilentlyContinue | Where-Object {
    $_.CommandLine -like "*uvicorn*app_comprehensive*"
} | Stop-Process -Force -ErrorAction SilentlyContinue
```

**Retry logic for API calls:**
```powershell
function Invoke-WithRetry {
    param([scriptblock]$ScriptBlock, [int]$MaxRetries = 3)
    for ($i = 0; $i -lt $MaxRetries; $i++) {
        try {
            & $ScriptBlock
            return
        } catch {
            if ($i -eq $MaxRetries - 1) { throw }
            Write-Host "Retry $($i + 1)/$MaxRetries..."
            Start-Sleep -Seconds 2
        }
    }
}
```

## Step 3 ‚Äî Harden Story Test

Update `tests/e2e/uat.story.video.spec.ts`:

**Explicit waits and resilient selectors:**
```typescript
// Wait for page load
await page.waitForLoadState('networkidle');

// More specific selectors
await page.getByRole('button', { name: /^Select PDF$/i }).waitFor();
await page.getByRole('button', { name: /^Select PDF$/i }).click();

// Wait for file dialog
const fileChooser = await page.waitForEvent('filechooser');
await fileChooser.setFiles(PLAN_PDF);

// Wait for upload feedback
await page.waitForSelector('.file-info.show', { timeout: 10000 });

// API calls with retry
await page.request.post(`${API}/v1/takeoff`, {
  data: { project_id: 'LYNN-001', pdf_path: PLAN_PDF },
  timeout: 30000
});
```

## Step 4 ‚Äî Reel V2 with Enhanced Graphics

Update `scripts/make_uat_video.ps1`:

**Lower-thirds captions:**
```bash
ffmpeg -i input.mp4 -vf "
drawtext=text='JCW Estimator - Test: %{metadata:test_name}':fontcolor=white:fontsize=36:box=1:boxcolor=black@0.7:boxborderw=10:x=50:y=h-150,
drawtext=text='Status: %{metadata:status}':fontcolor=green:fontsize=28:x=50:y=h-100,
drawtext=text='Duration: %{metadata:duration}s':fontcolor=white:fontsize=24:x=50:y=h-60
" -c:a copy output.mp4
```

**Chapter slates between tests:**
```bash
# Generate slate image
ffmpeg -f lavfi -i color=blue:size=1920x1080:duration=2 -vf "
drawtext=text='Test %{n+1}: %{metadata:test_name}':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=(h-text_h)/2-50,
drawtext=text='Status: %{metadata:status}':fontcolor=yellow:fontsize=36:x=(w-text_w)/2:y=(h+text_h)/2
" -y "slate_{n}.mp4"
```

**Failure red banners:**
```bash
# For failed tests, add red overlay
ffmpeg -i input.mp4 -vf "
drawtext=text='FAILED':fontcolor=red:fontsize=72:box=1:boxcolor=black@0.3:x=(w-text_w)/2:y=50
" -c:a copy failed_output.mp4
```

## Step 5 ‚Äî Enhanced Receipt

Create `output/uat/UAT_REEL_V2.md` with:

- Video thumbnail/link
- Test-by-test breakdown with timestamps
- Performance metrics
- Links to traces/screenshots
- Demo command for replay

## Step 6 ‚Äî Commit & Push

**Files to commit:**
- `scripts/demo_run.ps1` (new)
- `scripts/uat_run.ps1` (enhanced)
- `tests/e2e/uat.story.video.spec.ts` (hardened)
- `scripts/make_uat_video.ps1` (reel v2)
- `output/uat/UAT_REEL_V2.mp4` (generated)
- `output/uat/UAT_REEL_V2.md` (enhanced receipt)
- `output/R2.3_RECEIPT.md` (completion receipt)

**Commit message:**
```
feat(r2.3): always-works demo with auto-server, retry logic, resilient tests, and reel v2
```

## Acceptance Criteria

‚úÖ **One-click demo:** `pwsh -File scripts/demo_run.ps1` works end-to-end
‚úÖ **API auto-management:** Starts healthy, cleans up properly
‚úÖ **Resilient tests:** Story test passes consistently with real video
‚úÖ **Reel v2:** Lower-thirds, chapter slates, failure banners
‚úÖ **‚â•1 real clip:** Non-placeholder video content guaranteed
‚úÖ **Valid links:** All receipts and reports accessible via HTTP server

## Failure Handling

If any step fails:
- Write diagnosis to `output/uat/UAT_DIAGNOSIS_R2.3.md`
- Include: API logs, test output, video generation errors
- Continue with partial artifacts
- Still commit for debugging

## Demo Command

```bash
pwsh -File scripts/demo_run.ps1
# Then open: http://127.0.0.1:8000/output/uat/UAT_REEL_V2.mp4
