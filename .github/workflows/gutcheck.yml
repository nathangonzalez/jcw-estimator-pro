name: Gut-Check (Read-Only)

on:
  push:
    branches: [ master, main ]
  pull_request:

jobs:
  gutcheck:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi

      - name: Run Gut-Check (read-only)
        id: gutcheck
        run: |
          python scripts/ci_gutcheck.py | tee ci_gutcheck.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-artifacts
          path: |
            output/BENCH/LYNN_GUTCHECK.json
            output/BENCH/LYNN_GUTCHECK.md
            output/BENCH/LYNN_DASHBOARD.html
            ci_gutcheck.log
          if-no-files-found: warn

      - name: Summarize
        if: always()
        run: |
          echo "## Gut-Check Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f output/BENCH/LYNN_GUTCHECK.md ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_See full report in artifacts (LYNN_GUTCHECK.md / .json)_" >> $GITHUB_STEP_SUMMARY
            head -n 40 output/BENCH/LYNN_GUTCHECK.md >> $GITHUB_STEP_SUMMARY
          else
            echo "Gut-Check was skipped (inputs missing). See ci_gutcheck.log." >> $GITHUB_STEP_SUMMARY
          fi
